# Руководство по эксплуатации и мониторингу

Этот документ содержит инструкции по управлению и мониторингу сервиса сбора данных Binance в рабочем режиме.

## 1. Управление конфигурацией

Все настройки сервиса производятся через переменные окружения, которые рекомендуется определять в файле `.env`.

**Важно:** Любые изменения в файле `.env` требуют перезапуска приложения, чтобы они вступили в силу.

### Основные параметры:

- `DB_DSN`: Строка подключения к вашей базе данных PostgreSQL/TimescaleDB.
  - Формат: `postgresql://user:password@host:port/database`

- `SPOT_SYMBOLS` и `FUTURES_SYMBOLS`: Списки тикеров для спотового и фьючерсного рынков, разделенные запятыми.
  - Пример: `SPOT_SYMBOLS=btcusdt,ethusdt,solusdt`

- `OPEN_INTEREST_POLL_INTERVAL` и `DEPTH_SNAPSHOT_POLL_INTERVAL`: Интервалы в секундах для опроса данных через REST API.
  - Значение по умолчанию: `60`

### Управление потоками данных

Вы можете включать и отключать целые группы потоков данных. Установите значение `true` для включения или `false` для выключения.

- `ENABLE_WEBSOCKET_SPOT`: WebSocket-потоки для спотового рынка.
- `ENABLE_WEBSOCKET_FUTURES`: WebSocket-потоки для фьючерсного рынка.
- `ENABLE_OPEN_INTEREST`: Сбор данных по открытому интересу.
- `ENABLE_DEPTH_SNAPSHOT`: Сбор полных снимков стакана.

---

## 2. Процесс мониторинга

Для обеспечения стабильной работы сервиса необходимо отслеживать три ключевых аспекта: логи, состояние каналов и производительность.

### 2.1. Мониторинг логов

Сервис ведет два лог-файла:

- **`system.log`**: Содержит все информационные сообщения (`INFO`), предупреждения (`WARNING`) и ошибки (`ERROR`). Полезен для детального анализа работы.
- **`error.log`**: Содержит **только** ошибки (`ERROR`). **Этот файл нужно проверять в первую очередь**, если возникли подозрения на сбои.

**Обратите внимание на предупреждения (WARNING):**
Сообщения вроде `Received forceOrder message with missing 'o' or 'o.i' key` не являются критическими ошибками. Они информируют о том, что от Binance пришли неполные данные, и сервис их проигнорировал, чтобы избежать сбоя. Это нормальное поведение.

### 2.2. Мониторинг состояния каналов (Health Check)

Это основной способ автоматической проверки работоспособности сервиса.

- **Конечная точка:** `http://localhost:8000/health`
- **Команда для проверки:**
  ```bash
  curl -f http://localhost:8000/health
  ```

**Интерпретация результатов:**
- **Успех (Код ответа 200):** Если команда выполнилась молча, значит, все компоненты сервиса работают штатно.
- **Ошибка (Код ответа 503):** Если команда вернула ошибку (например, `curl: (22) The requested URL returned error: 503`), это означает, что один из каналов данных "завис" (давно не присылал данные) или потеряно соединение с БД. В теле ответа будет указана причина.

**Рекомендация:** Настройте автоматический запуск этой команды (например, через `cron` раз в 5 минут) с отправкой уведомления при получении ошибки.

### 2.3. Мониторинг производительности (Metrics)

Сервис предоставляет метрики для системы мониторинга Prometheus.

- **Конечная точка:** `http://localhost:8000/metrics`
- **Ключевая метрика:** `messages_processed_total`

Эта метрика считает, сколько сообщений каждого типа было успешно обработано и записано в базу.

**Как использовать:**
Настройте ваш сервер Prometheus на сбор данных с этой конечной точки. В системе визуализации (например, Grafana) вы можете построить график этой метрики. Если график для какого-либо из потоков стал плоским (перестал расти), это означает, что данные из этого потока перестали поступать, даже если `/health` эндпоинт еще не показал ошибку.

---

## 3. Типичные проблемы и их решение

- **Проблема:** Приложение не запускается и падает с ошибкой базы данных, связанной с `PRIMARY KEY` или `create_hypertable`.
  - **Причина:** Скорее всего, вы обновили код до версии с измененной структурой таблицы, но в базе данных осталась старая версия этой таблицы.
  - **Решение:** Подключитесь к базе данных и удалите "старую" таблицу с помощью команды `DROP TABLE table_name;`. После этого перезапустите приложение. Оно создаст таблицу заново с правильной структурой.
