# Подробная документация по работе скрипта

Этот документ содержит детальное описание архитектуры, источников данных, структуры базы данных и конфигурации проекта.

## 1. Общая архитектура

Проект представляет собой асинхронный сервис на Python (`asyncio`), предназначенный для непрерывного сбора данных с биржи Binance и их сохранения в базу данных.

Ключевые компоненты:
-   **`main.py`**: Главный файл, управляющий жизненным циклом приложения. Он инициализирует все компоненты, запускает их как асинхронные задачи и управляет их корректным завершением.
-   **`websocket_client.py`**: Отвечает за подключение к WebSocket-потокам Binance, получение данных в реальном времени и их отправку в общую очередь.
-   **`rest_client.py`**: Отвечает за периодический опрос REST API эндпоинтов Binance для получения данных, недоступных через WebSocket (например, открытый интерес).
-   **`database.py`**: Управляет подключением к базе данных PostgreSQL/TimescaleDB, инициализирует таблицы и выполняет пакетную запись данных.
-   **`alerter.py`**: Реализует логику для анализа ликвидаций и отправки алертов в `alert.log` на основе заданных условий.
-   **`config.py`**: Управляет всей конфигурацией приложения через переменные окружения (файл `.env`).
-   **`web_server.py`**: Предоставляет эндпоинты `/health` и `/metrics` для внешнего мониторинга.

## 2. Источники данных и потоки

Все данные берутся с официальных API биржи Binance.

### 2.1. WebSocket-потоки (Real-time)

Эти данные поступают непрерывно. Названия потоков (`stream`) конструируются из символа и типа потока, например `btcusdt@aggTrade`.

| Тип потока (`stream_type`) | Описание | Куда записывается |
| :--- | :--- | :--- |
| **`aggTrade`** | Агрегированные сделки. Каждая сделка представляет собой несколько сделок по одной цене. | Таблица `agg_trades` |
| **`depth@<скорость>`** | Обновления стакана (книги ордеров). Например `depth@500ms`. | Таблица `depth_updates` |
| **`!markPrice@arr@<скорость>`** | Цена маркировки для **всех** фьючерсных контрактов. Обновляется раз в 1 или 3 секунды. | Таблица `mark_prices` |
| **`!forceOrder@arr`** | Принудительные ликвидации для **всех** фьючерсных контрактов. | Таблица `force_orders` |

**Конфигурируемые параметры потоков в `config.py`:**
-   `spot_streams`: `['aggTrade', 'depth@500ms']`
-   `futures_streams`: `['aggTrade', 'depth@500ms', 'markPrice@arr@1s', 'forceOrder']`

### 2.2. REST API (Периодический опрос)

Эти данные запрашиваются раз в `N` секунд.

| Данные | Эндпоинт API | Описание | Куда записывается |
| :--- | :--- | :--- | :--- |
| **Open Interest** | `/fapi/v1/openInterest` | Статистика открытого интереса для фьючерсных контрактов. | Таблица `open_interest` |
| **Depth Snapshot** | `/api/v3/depth` (Spot), `/fapi/v1/depth` (Futures) | Полный снимок стакана (книги ордеров) до 1000 уровней. | Таблица `depth_snapshots` |

## 3. База данных и таблицы

Используется PostgreSQL с расширением TimescaleDB для эффективной работы с временными рядами.

### Таблица: `agg_trades`
Хранит агрегированные сделки.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `event_time` | `TIMESTAMPTZ` | Время события (сделки) | `E` из `aggTrade` |
| `symbol` | `TEXT` | Символ (например, `BTCUSDT`) | `s` из `aggTrade` |
| `aggregate_trade_id` | `BIGINT` | Уникальный ID агрегированной сделки | `a` из `aggTrade` |
| `payload` | `JSONB` | Полный JSON-объект события | Весь объект `aggTrade` |

### Таблица: `depth_updates`
Хранит обновления стакана.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `event_time` | `TIMESTAMPTZ` | Время события | `E` из `depthUpdate` |
| `symbol` | `TEXT` | Символ | `s` из `depthUpdate` |
| `first_update_id` | `BIGINT` | ID первого обновления в событии | `U` из `depthUpdate` |
| `final_update_id` | `BIGINT` | ID последнего обновления в событии | `u` из `depthUpdate` |
| `payload` | `JSONB` | Полный JSON-объект события | Весь объект `depthUpdate` |

### Таблица: `mark_prices`
Хранит цены маркировки.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `event_time` | `TIMESTAMPTZ` | Время события | `E` из `markPriceUpdate` |
| `symbol` | `TEXT` | Символ | `s` из `markPriceUpdate` |
| `payload` | `JSONB` | Полный JSON-объект события | Весь объект `markPriceUpdate` |

### Таблица: `force_orders`
Хранит принудительные ликвидации.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `event_time` | `TIMESTAMPTZ` | Время события | `E` из `forceOrder` |
| `transaction_time` | `TIMESTAMPTZ` | Время совершения сделки | `o.T` из `forceOrder` |
| `symbol` | `TEXT` | Символ | `o.s` из `forceOrder` |
| `side` | `TEXT` | Сторона (`SELL` или `BUY`) | `o.S` из `forceOrder` |
| `quantity` | `DECIMAL` | Объем ликвидации | `o.q` из `forceOrder` |
| `payload` | `JSONB` | Полный JSON-объект события | Весь объект `forceOrder` |

### Таблица: `open_interest`
Хранит статистику открытого интереса.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `time` | `TIMESTAMPTZ` | Время получения данных | Текущее время при запросе |
| `symbol` | `TEXT` | Символ | `symbol` из ответа API |
| `open_interest` | `DECIMAL` | Значение открытого интереса | `openInterest` из ответа API |
| `payload` | `JSONB` | Полный JSON-объект ответа | Весь объект ответа API |

### Таблица: `depth_snapshots`
Хранит полные снимки стакана.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `time` | `TIMESTAMPTZ` | Время получения данных | Текущее время при запросе |
| `symbol` | `TEXT` | Символ | `symbol` из параметров запроса |
| `market_type` | `TEXT` | Тип рынка (`spot` или `futures`) | Определяется в коде |
| `payload` | `JSONB` | Полный JSON-объект ответа | Весь объект ответа API |
