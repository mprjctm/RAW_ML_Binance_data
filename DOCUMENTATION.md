# Подробная документация по работе скрипта

Этот документ содержит детальное описание архитектуры, источников данных, структуры базы данных и конфигурации проекта.

## 1. Общая архитектура

Проект представляет собой асинхронный сервис на Python (`asyncio`), предназначенный для непрерывного сбора данных с биржи Binance и их сохранения в базу данных.

Ключевые компоненты:
-   **`main.py`**: Главный файл, управляющий жизненным циклом приложения. Он инициализирует все компоненты, запускает их как асинхронные задачи и управляет их корректным завершением.
-   **`websocket_client.py`**: Отвечает за подключение к WebSocket-потокам Binance, получение данных в реальном времени и их отправку в общую очередь.
-   **`rest_client.py`**: Отвечает за периодический опрос REST API эндпоинтов Binance для получения данных, недоступных через WebSocket (например, открытый интерес).
-   **`database.py`**: Управляет подключением к базе данных PostgreSQL/TimescaleDB, инициализирует таблицы и выполняет пакетную запись данных.
-   **`config.py`**: Управляет всей конфигурацией приложения через переменные окружения (файл `.env`).
-   **`web_server.py`**: Предоставляет эндпоинты `/health` и `/metrics` для внешнего мониторинга.

## 2. Источники данных и потоки

Все данные берутся с официальных API биржи Binance.

### 2.1. WebSocket-потоки (Real-time)

Эти данные поступают непрерывно. Названия потоков (`stream`) конструируются из символа и типа потока, например `btcusdt@aggTrade`.

| Тип потока (`stream_type`) | Описание | Куда записывается |
| :--- | :--- | :--- |
| **`aggTrade`** | Агрегированные сделки. Каждая сделка представляет собой несколько сделок по одной цене. | Таблица `agg_trades` |
| **`depth@<скорость>`** | Обновления стакана (книги ордеров). Например `depth@500ms`. | Таблица `depth_updates` |
| **`!markPrice@arr@<скорость>`** | Цена маркировки для **всех** фьючерсных контрактов. Обновляется раз в 1 или 3 секунды. | Таблица `mark_prices` |
| **`!forceOrder@arr`** | Принудительные ликвидации для **всех** фьючерсных контрактов. | Таблица `force_orders` |

**Конфигурируемые параметры потоков в `config.py`:**
-   `spot_streams`: `['aggTrade', 'depth@500ms']`
-   `futures_streams`: `['aggTrade', 'depth@500ms', 'markPrice@arr@1s', 'forceOrder']`

### 2.2. REST API (Периодический опрос)

Эти данные запрашиваются раз в `N` секунд.

| Данные | Эндпоинт API | Описание | Куда записывается |
| :--- | :--- | :--- | :--- |
| **Open Interest** | `/fapi/v1/openInterest` | Статистика открытого интереса для фьючерсных контрактов. | Таблица `open_interest` |
| **Depth Snapshot** | `/api/v3/depth` (Spot), `/fapi/v1/depth` (Futures) | Полный снимок стакана (книги ордеров) до 1000 уровней. | Таблица `depth_snapshots` |

## 3. База данных и таблицы

Используется PostgreSQL с расширением TimescaleDB для эффективной работы с временными рядами.

### Таблица: `agg_trades`
Хранит агрегированные сделки.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `event_time` | `TIMESTAMPTZ` | Время события (сделки) | `E` из `aggTrade` |
| `symbol` | `TEXT` | Символ (например, `BTCUSDT`) | `s` из `aggTrade` |
| `aggregate_trade_id` | `BIGINT` | Уникальный ID агрегированной сделки | `a` из `aggTrade` |
| `payload` | `JSONB` | Полный JSON-объект события | Весь объект `aggTrade` |

### Таблица: `depth_updates`
Хранит обновления стакана.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `event_time` | `TIMESTAMPTZ` | Время события | `E` из `depthUpdate` |
| `symbol` | `TEXT` | Символ | `s` из `depthUpdate` |
| `first_update_id` | `BIGINT` | ID первого обновления в событии | `U` из `depthUpdate` |
| `final_update_id` | `BIGINT` | ID последнего обновления в событии | `u` из `depthUpdate` |
| `payload` | `JSONB` | Полный JSON-объект события | Весь объект `depthUpdate` |

### Таблица: `mark_prices`
Хранит цены маркировки.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `event_time` | `TIMESTAMPTZ` | Время события | `E` из `markPriceUpdate` |
| `symbol` | `TEXT` | Символ | `s` из `markPriceUpdate` |
| `payload` | `JSONB` | Полный JSON-объект события | Весь объект `markPriceUpdate` |

### Таблица: `force_orders`
Хранит принудительные ликвидации.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `event_time` | `TIMESTAMPTZ` | Время события | `E` из `forceOrder` |
| `transaction_time` | `TIMESTAMPTZ` | Время совершения сделки | `o.T` из `forceOrder` |
| `symbol` | `TEXT` | Символ | `o.s` из `forceOrder` |
| `side` | `TEXT` | Сторона (`SELL` или `BUY`) | `o.S` из `forceOrder` |
| `quantity` | `DECIMAL` | Объем ликвидации | `o.q` из `forceOrder` |
| `payload` | `JSONB` | Полный JSON-объект события | Весь объект `forceOrder` |

### Таблица: `open_interest`
Хранит статистику открытого интереса.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `time` | `TIMESTAMPTZ` | Время получения данных | Текущее время при запросе |
| `symbol` | `TEXT` | Символ | `symbol` из ответа API |
| `open_interest` | `DECIMAL` | Значение открытого интереса | `openInterest` из ответа API |
| `payload` | `JSONB` | Полный JSON-объект ответа | Весь объект ответа API |

### Таблица: `depth_snapshots`
Хранит полные снимки стакана.

| Поле | Тип | Описание | Откуда берется |
| :--- | :--- | :--- | :--- |
| `time` | `TIMESTAMPTZ` | Время получения данных | Текущее время при запросе |
| `symbol` | `TEXT` | Символ | `symbol` из параметров запроса |
| `market_type` | `TEXT` | Тип рынка (`spot` или `futures`) | Определяется в коде |
| `payload` | `JSONB` | Полный JSON-объект ответа | Весь объект ответа API |

---

## 4. Концепция Торговой Стратегии

Этот проект не содержит готовую к запуску торговую стратегию, но предоставляет все необходимые данные и "строительные блоки" (продвинутые индикаторы) для ее создания и тестирования. Основная идея заключается в поиске рыночных неэффективностей и аномалий, связанных с поведением толпы и действиями крупных игроков.

Ниже описана логика каждого из кастомных индикаторов и то, как их можно интерпретировать для построения торговой стратегии.

### 4.1. Order Flow Delta (Дельта Потока Ордеров)

-   **Что это?** Разница между объемом рыночных покупок и продаж.
-   **Торговая идея:** Показывает, кто в данный момент доминирует на рынке: агрессивные покупатели или продавцы.
-   **Примеры сигналов:**
    -   **Дивергенция:** Цена устанавливает новый минимум, а дельта — нет (она выше предыдущего минимума). Это означает, что давление продаж ослабевает, несмотря на падение цены. Это сильный бычий сигнал, указывающий на возможный разворот вверх.
    -   **Импульс:** Резкий и устойчивый рост дельты подтверждает силу восходящего тренда (и наоборот для нисходящего).

### 4.2. Panic Index (Индекс Паники)

-   **Что это?** Композитный индикатор, сочетающий высокую волатильность и аномальные всплески объема.
-   **Торговая идея:** Идентифицирует моменты эмоциональной кульминации на рынке — паники или эйфории. Такие моменты часто предшествуют разворотам, так как "умные деньги" входят в рынок против "слабых рук".
-   **Примеры сигналов:**
    -   **Контртрендовый вход:** Резкий скачок "Индекса Паники" во время сильного падения цены может сигнализировать о дне рынка. Стратегия может заключаться в покупке после того, как индекс достигнет пика и начнет снижаться.
    -   **Фильтр:** Не входить в сделки, когда "Индекс Паники" очень высок, так как рынок слишком непредсказуем.

### 4.3. Absorption Strength (Сила Поглощения)

-   **Что это?** Индикатор, показывающий, насколько эффективно рынок "поглощает" давление продаж или покупок без значительного изменения цены.
-   **Торговая идея:** Обнаружение крупных лимитных ордеров ("стен"), которые не видны в обычном стакане. Если на рынок выливается огромный объем продаж, а цена стоит на месте, значит, крупный игрок "поглощает" все эти продажи.
-   **Примеры сигналов:**
    -   **Сигнал на покупку:** Во время падения цены появляется высокое (по модулю) отрицательное значение "Силы Поглощения". Это означает, что кто-то активно скупает все, что продается, формируя сильный уровень поддержки. Это может быть отличной точкой для входа в лонг.
    -   **Сигнал на продажу:** Зеркальная ситуация при росте цены. Если дельта покупок высокая, а цена упирается в "невидимую стену", это сигнал о наличии крупного продавца.

### 4.4. Cascade Exhaustion (Истощение Каскада)

-   **Что это?** Индикатор интенсивности принудительных ликвидаций.
-   **Торговая идея:** Каскадные ликвидации — это самоусиливающийся процесс. Индикатор помогает определить, когда этот процесс подходит к концу.
-   **Примеры сигналов:**
    -   **Покупка на дне:** После серии каскадных лонговых ликвидаций (которые толкали цену вниз) индикатор показывает резкое снижение активности. Это означает, что большинство "слабых" лонгов уже выбито с рынка, и давление продаж иссякло. Это хороший момент для поиска точки входа в лонг.

### 4.5. Сборка комплексной стратегии

Полноценная стратегия может комбинировать эти сигналы. Например:

1.  **Условие для входа в лонг:**
    -   "Индекс Паники" показывает недавний пик и начинает снижаться.
    -   Одновременно с этим "Сила Поглощения" показывает сильное поглощение продаж.
    -   В качестве подтверждения, "Дельта Потока Ордеров" показывает бычью дивергенцию.

2.  **Управление риском (Обязательно!):**
    -   **Стоп-лосс:** Необходимо определить уровень стоп-лосса (например, под минимум, где произошло поглощение).
    -   **Тейк-профит:** Определить цели для фиксации прибыли.

3.  **Фильтры:**
    -   Не торговать при определенных рыночных условиях (например, во время важных новостей или при низкой ликвидности).

Таким образом, данный проект предоставляет мощные инструменты для анализа рыночной микроструктуры, на основе которых можно создавать и тестировать сложные и потенциально высокодоходные торговые алгоритмы.
