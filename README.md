# Cборщик рыночных данных Binance для ML

Этот проект представляет собой сервис для сбора рыночных данных с криптовалютной биржи Binance. Он собирает данные по WebSocket и REST API, нормализует их и сохраняет в базу данных PostgreSQL/TimescaleDB для дальнейшего использования в задачах машинного обучения.

## Функциональность

- **Сбор данных из нескольких источников:**
  - **WebSocket (Real-time):** `aggTrade`, `depth@100ms`, `!markPrice@arr`, `!forceOrder@arr` для спотового и фьючерсного рынков.
  - **REST API (Периодический опрос):** `openInterest` (фьючерсы) и полные снимки стакана (`depth snapshot`).
- **Надежное хранение:** Данные сохраняются в PostgreSQL / TimescaleDB. "Сырые" данные хранятся в формате `JSONB` для гибкости.
- **Отказоустойчивость и стабильность:**
  - **Автоматическое переподключение:** Клиенты WebSocket и REST автоматически переподключаются в случае сбоев сети.
  - **Мониторинг задач:** Внутренний "супервизор" отслеживает состояние всех ключевых компонентов. В случае сбоя одного из них, в лог записывается критическая ошибка, и сервис корректно перезапускается.
  - **Корректное завершение:** Приложение корректно завершает работу по сигналам `SIGINT` и `SIGTERM`, закрывая все соединения.
- **Алертинг по ликвидациям (Новое):**
  - Сервис отслеживает принудительные ликвидации (`forceOrder`).
  - Генерирует алерт в `alert.log`, если ликвидация происходит, когда цена находится вблизи **экстремумов** (минимума или максимума) за последние `N` дней.
  - "Близость" к экстремуму определяется настраиваемым процентом отклонения `X`. Например, если `X=5%`, алерт сработает, если цена находится в пределах 5% от N-дневного минимума или максимума.
  - Параметры `N` и `X` настраиваются в конфигурационном файле.
- **Наблюдаемость (Observability):**
  - Конечная точка `/metrics` для сбора метрик в формате Prometheus.
  - Конечная точка `/health` для интеллектуальной проверки состояния всех компонентов сервиса.
  - Периодическое логирование размера внутренней очереди данных для диагностики производительности.

## Системные требования

- Python 3.10+
- PostgreSQL (рекомендуется 12+) с установленным расширением TimescaleDB.

## Установка и настройка

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <repository-url>
    cd <repository-directory>
    ```

2.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

3.  **Настройте переменные окружения:**
    - Скопируйте файл с примером конфигурации:
      ```bash
      cp .env.example .env
      ```
    - Откройте файл `.env` в текстовом редакторе и укажите ваши настройки. Пример основных настроек:
      ```dotenv
      # Строка подключения к вашей базе данных PostgreSQL / TimescaleDB
      DB_DSN="postgresql://user:password@localhost:5432/binance_data"

      # Списки символов для отслеживания (через запятую, без пробелов)
      SPOT_SYMBOLS="btcusdt,ethusdt"
      FUTURES_SYMBOLS="btcusdt,ethusdt"

      # --- НОВОЕ: Настройки алертов по ликвидациям ---
      # Включить или отключить функцию алертов
      ENABLE_LIQUIDATION_ALERTS=true
      # Период в днях (N) для поиска исторических минимумов и максимумов
      ALERT_MAX_DAYS_LOOKBACK=30
      # Процент отклонения (X) от экстремума, который триггерит алерт
      ALERT_EXTREMUM_DEVIATION_PERCENT=5.0
      ```

## Запуск приложения

Для запуска сервиса выполните команду:
```bash
python main.py
```
Приложение начнет собирать данные. Логи будут выводиться в консоль, а также записываться в файлы:
- `system.log`: Основные системные события и информация.
- `error.log`: Только ошибки.
- `alert.log`: Только сработавшие алерты по ликвидациям.

## Мониторинг

Сервис предоставляет две конечные точки для мониторинга, доступные по адресу `http://localhost:8000`.

### Проверка состояния (`/health`)

Эта конечная точка выполняет глубокую проверку работоспособности всех компонентов (подключение к БД, активность потоков данных).

Вы можете использовать ее в своих скриптах мониторинга:
```bash
curl -f http://localhost:8000/health
```
- Если команда выполнится успешно (код ответа 200), сервис в порядке.
- Если команда завершится с ошибкой (например, `curl: (22) The requested URL returned error: 503`), значит, один из компонентов неисправен. В теле ответа будет указана причина.

### Метрики (`/metrics`)

Эта конечная точка предоставляет метрики в формате, совместимом с Prometheus. Вы можете настроить ваш сервер Prometheus для сбора этих данных для дальнейшего анализа и создания алертов.
```bash
curl http://localhost:8000/metrics
```
Основная метрика `messages_processed_total` показывает количество обработанных сообщений по каждому типу потока.
