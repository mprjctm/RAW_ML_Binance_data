# Cборщик рыночных данных Binance для ML

Этот проект представляет собой сервис для сбора рыночных данных с криптовалютной биржи Binance. Он собирает данные по WebSocket и REST API, нормализует их и сохраняет в базу данных PostgreSQL/TimescaleDB для дальнейшего использования в задачах машинного обучения.

## Функциональность

- **Сбор данных из нескольких источников:**
  - **WebSocket (Real-time):** `aggTrade`, `depth@100ms`, `!markPrice@arr`, `!forceOrder@arr` для спотового и фьючерсного рынков.
  - **REST API (Периодический опрос):** `openInterest` (фьючерсы) и полные снимки стакана (`depth snapshot`).
- **Надежное хранение:** Данные сохраняются в PostgreSQL / TimescaleDB. "Сырые" данные хранятся в формате `JSONB` для гибкости.
- **Отказоустойчивость:** Клиенты WebSocket и REST автоматически переподключаются в случае сбоев сети.
- **Наблюдаемость (Observability):**
  - Конечная точка `/metrics` для сбора метрик в формате Prometheus.
  - Конечная точка `/health` для интеллектуальной проверки состояния всех компонентов сервиса.
- **Корректное завершение:** Приложение корректно завершает работу по сигналам `SIGINT` и `SIGTERM`, закрывая все соединения.

## Системные требования

- Python 3.10+
- PostgreSQL (рекомендуется 12+) с установленным расширением TimescaleDB.

## Установка и настройка

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <repository-url>
    cd <repository-directory>
    ```

2.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

3.  **Настройте переменные окружения:**
    - Скопируйте файл с примером конфигурации:
      ```bash
      cp .env.example .env
      ```
    - Откройте файл `.env` в текстовом редакторе и укажите ваши настройки. Как минимум, вам нужно будет указать правильную строку подключения к базе данных (`DB_DSN`).
      ```dotenv
      # Строка подключения к вашей базе данных PostgreSQL / TimescaleDB
      DB_DSN="postgresql://user:password@localhost:5432/binance_data"

      # Списки символов для отслеживания (через запятую, без пробелов)
      SPOT_SYMBOLS="btcusdt,ethusdt"
      FUTURES_SYMBOLS="btcusdt,ethusdt"
      ```

## Запуск приложения

Для запуска сервиса выполните команду:
```bash
python main.py
```
Приложение начнет собирать данные. Логи будут выводиться в консоль, а также записываться в файлы `system.log` и `error.log`.

## Мониторинг

Сервис предоставляет две конечные точки для мониторинга, доступные по адресу `http://localhost:8000`.

### Проверка состояния (`/health`)

Эта конечная точка выполняет глубокую проверку работоспособности всех компонентов (подключение к БД, активность потоков данных).

Вы можете использовать ее в своих скриптах мониторинга:
```bash
curl -f http://localhost:8000/health
```
- Если команда выполнится успешно (код ответа 200), сервис в порядке.
- Если команда завершится с ошибкой (например, `curl: (22) The requested URL returned error: 503`), значит, один из компонентов неисправен. В теле ответа будет указана причина.

### Метрики (`/metrics`)

Эта конечная точка предоставляет метрики в формате, совместимом с Prometheus. Вы можете настроить ваш сервер Prometheus для сбора этих данных для дальнейшего анализа и создания алертов.
```bash
curl http://localhost:8000/metrics
```
Основная метрика `messages_processed_total` показывает количество обработанных сообщений по каждому типу потока.
